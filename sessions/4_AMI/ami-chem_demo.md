# AMI-Chem

In this example we will use AMI's chemistry tools to analyse a paper and reconstruct semantic representations of the chemistry in it.

We will extract data from the paper at four different levels:

1. Given a paper, identify chemical molecules in the text and reconstruct their semantic representation.
2. Given a picture of a chemical molecule, reconstruct the semantic representation.
3. Given a paper, identify all the figures that contain chemical molecules and reconstruct their semantic representation.
4. Given a paper, identify all figures that contain reactions between chemical molecules and reconstruct their semantic representation.

## Contents

- [Software description](#software-description)
- [Example: molecules from text](#example-molecules-from-text)
- [Example: molecules from figures 1](#example-molecules-from-figures-1)
- [Example: molecules from figures 2](#example-molecules-from-figures-2)
- [Example: reactions from figures](#example-reactions-from-figures)

## Software description

### AMI-chem

Extracts complete chemical structures and 2-D coordinates from vector-based chemical diagrams

* **Input**: SVG diagram or PDF containing PDFs
* **Output**: 
  - CML including group expansion and coordinates from image
  - PNG (coordinates generated by [CDK](http://sourceforge.net/projects/cdk/))
  - SVG (coordinates generated by [CDK](http://sourceforge.net/projects/cdk/))
  - SMILES 
  - results.xml (contains CML)
* **Method**: extracts vectors and characters from diagram and builds an (organic) chemical structure
* **Note**: Does NOT run OSCAR or OPSIN and does not translate names
* **Limitations**:
  - Does not run on HTML or XML or PDF text (will have separate plugin for that)
  - Does not run on pixel images (but will very soon)
  - Can extract, but does not understand, dotted bonds, thick bonds, wiggly bonds (and nor do most humans)
  - Hardcoded list of chemical groups.

## Example: molecules from text

We will work with a patent as an example: "[Production of fatty alcohols with fatty alcohol forming acyl-coa reductases](http://www.google.com/patents/US20110000125)".

The text is rich with names of chemical molecules. We will use the OSCAR4 library ([site](https://bitbucket.org/wwmm/oscar4/wiki/Home) | [paper](http://www.ncbi.nlm.nih.gov/pmc/articles/PMC3205045/)) wrapped in a tool called [chemextractor](https://bitbucket.org/mjw99/chemextractorpublic/) to detect chemical entities in the text and convert them to a set of standard representations.

The patent PDF is already on your machine at `~/ebi_workshop_20141006/sessions/4_AMI/chem_files/US20110000125.pdf`.

To convert the PDF to a dataset of the chemical entities inside it, open up a terminal and run:

```bash
$ oscarpdf2json US20110000125.pdf > US20110000125.json
```

There should now be a file in the current directory called `US20110000125.json`. This is a [JSON formatted](http://en.wikipedia.org/wiki/JSON) file. JSON can be viewed nicely in the browser. To view the file, run the following in the terminal:

```bash
$ iceweasel && iceweasel --new-tab US20110000125.json
```

You can verify the results manually by using [ChEBI](http://www.ebi.ac.uk/chebi), [Chembl](https://www.ebi.ac.uk/chembl/), or [PubChem](https://pubchem.ncbi.nlm.nih.gov/) to search for the InChiKey and other descriptors included in the JSON output.

## Example: molecules from figures 1

We will work with a chemistry paper, "[Comparative Chemistry of Aspergillus oryzae (RIB40) and
A. flavus (NRRL 3357)](http://dx.doi.org/10.3390/metabo2010039)", which contains names and structures of many metabolites and metabolic reactions.

A PDF of the article is included in the virtual machine: `ebi_workshop_20141006/sessions/4_AMI/chem_files/metabolites-02-00039.pdf` or can be [downloaded](https://raw.githubusercontent.com/ContentMine/ebi_workshop_20141006/master/sessions/4_AMI/chem_files/metabolites-02-00039.pdf).

We are going to use the figure on page two to demonstrate the process of reconstructing semantic chemical markup from a preserved vector diagram. Below is a screenshot of the page...

![image of Figure 2](https://raw.githubusercontent.com/ContentMine/ebi_workshop_20141006/master/sessions/4_AMI/chem_files/metabo2010039.png)

In the PDF visit Page 2 and zoom in and out. Verify that the image can be scaled many times without fuzziness or jagged lines appearing. This shows that the publishers have preserved the vector representation of the image.

AMI has previously been run on this PDF to extract  the vector diagrams. It has extracted all subsets of vectors into chunks categorised by page, section and image. This figure is `g.2.12.3`: page 2, section 12, image 3.

Here's the figure:

<img src="https://rawgithub.com/ContentMine/ebi_workshop_20141006/master/sessions/4_AMI/chem_files/image.g.2.13.svg" width="250">

And its source:

```
<?xml version="1.0" encoding="UTF-8"?>
<svg height="800.0" width="700.0" xmlns="http://www.w3.org/2000/svg">
 <g title="org.xmlcml.svg2xml.page.MixedAnalyzer2" id="g.2.13" transform="matrix(1.0,0.0,0.0,1.0,-386.04,-508.02000000000004)">
   <path stroke="black" fill="#000000" stroke-width="0.0" svgx:z="1775" d="M415.26 526.26 L415.26 517.98 C415.26 517.86 415.38 517.74 415.5 517.74 C415.62 517.74 415.74 517.86 415.74 517.98 L415.74 526.26 C415.74 526.44 415.62 526.56 415.5 526.56 C415.38 526.56 415.26 526.44 415.26 526.26 " xmlns:svgx="http://www.xml-cml.org/schema/svgx"/>
   <path stroke="black" fill="#000000" stroke-width="0.0" svgx:z="1776" d="M417.42 526.26 L417.42 517.98 C417.42 517.86 417.54 517.74 417.72 517.74 C417.84 517.74 417.96 517.86 417.96 517.98 L417.96 526.26 C417.96 526.44 417.84 526.56 417.72 526.56 C417.54 526.56 417.42 526.44 417.42 526.26 " xmlns:svgx="http://www.xml-cml.org/schema/svgx"/>
   ...
   <text stroke="none" fill="#000000" svgx:fontName="CDPKAC+ArialMT" svgx:width="778.0" font-family="Helvetica" font-weight="normal" svgx:z="1774" x="413.22" y="516.6" font-size="8.58" xmlns:svgx="http://www.xml-cml.org/schema/svgx">O</text>
   <text stroke="none" fill="#000000" svgx:fontName="CDPKAC+ArialMT" svgx:width="722.0" font-family="Helvetica" font-weight="normal" svgx:z="1777" x="386.04" y="528.84" font-size="8.58" xmlns:svgx="http://www.xml-cml.org/schema/svgx">H</text>
   ...
 </g>
</svg>
```

The `path`s represent the bonds, and the `text`s are the element symbols (atoms). AMI-chem can interpret this.

Now we will run AMI-chem on the diagram. Open up a terminal and run:

```bash
$ ami-chem -i /home/workshop/ebi_workshop_20141006/sessions/4_AMI/chem_files/image.g.2.13.svg
```

You should see output that looks something like this:

```bash
245  [main] INFO  org.xmlcml.xhtml2stm.visitor.chem.ChemVisitor  - SVGContainer name: /Users/pm286/workspace/xhtml2stm/./src/test/resources/org/xmlcml/xhtml2stm/molecules/image.g.2.13.svg
245  [main] INFO  org.xmlcml.xhtml2stm.visitor.chem.ChemVisitor  - Working with svgContainer: /Users/pm286/workspace/xhtml2stm/./src/test/resources/org/xmlcml/xhtml2stm/molecules/image.g.2.13.svg
1686 [main] DEBUG org.xmlcml.xhtml2stm.visitor.chem.MoleculeCreator  - Looking for reactions
2138 [main] DEBUG org.xmlcml.xhtml2stm.visitor.chem.MoleculeCreator  - Molecule potentially part of a reaction ((384.63977442374846,459.1559855762515),(508.7623916951517,554.7226083048484)) 16 C1(C(=C(OC(=C1[H])C(O[H])([H])[H])[H])O[H])=O
...
3219 [main] DEBUG org.xmlcml.xhtml2stm.visitor.VisitorOutput  - outputFile: target/image.g.2.13.xml
```

The `C1(C(=C(OC(=C1[H])C(O[H])([H])[H])[H])O[H])=O` is an inline chemical formula in SMILES format.

There will also be images...

| PNG | SVG |
| --- | --- |
| ![png from ami-chem](https://raw.githubusercontent.com/ContentMine/ebi_workshop_20141006/master/sessions/4_AMI/chem_files/image.g.2.13.svg.molecule0.png) | ![SVG from ami-chem](https://rawgithub.com/ContentMine/ebi_workshop_20141006/master/sessions/4_AMI/chem_files/image.g.2.13.svg.molecule0.svg) |

Note that the image is NOT a copy of the original. **It is completely generated from the semantic representation**. This is important: it means the new image cannot infringe copyright.

### Checking results

#### Daylight Depict

Visit [Daylight Depict site](http://www.daylight.com/daycgi/depict), paste in the string C1(C(=C(OC(=C1[H])C(O[H])([H])[H])[H])O[H])=O and you'll see a picture confirming the structure (it uses a different drawing convention, with circles, but it's the same molecule).

<div style="text-align: center;">
  <img src="https://raw.githubusercontent.com/ContentMine/ebi_workshop_20141006/master/sessions/4_AMI/chem_files/image.g.2.13.smiles.png" width=350px align="center">
</div>

#### ChEBI

Visit ChEBI [ChemicalStructuresOfBiologicalInterest](http://www.ebi.ac.uk/chebi/) and search for "kojic acid":

<img src="https://raw.githubusercontent.com/ContentMine/ebi_workshop_20141006/master/sessions/4_AMI/chem_files/kojic.chebi.png" width=500px align="center">

This should return results like:

<img src="https://raw.githubusercontent.com/ContentMine/ebi_workshop_20141006/master/sessions/4_AMI/chem_files/kojic.chebi.2.png" width=350px align="center">

This matches the original image, the semantically reconstructed SVG/PNG, and the reconstruction from the InChi string.

### Visualising molecules

AMI-chem also generates CML (Chemical Markup Language) files which contain the complete sematic results for the molecule. There shoule be a file like this:

```
target/image.g.2.13.xml/image.g.2.13.svg.molecule0.cml 
```

The contents of the file are CML:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<molecule x2="421.89788" y2="531.7425000000001" xmlns="http://www.xml-cml.org/schema">
  <atomArray>
    <atom id="a11" elementType="C" x2="41.641" y2="-52.553" hydrogenCount="0"/>
    <atom id="a12" elementType="C" x2="40.62" y2="-53.19" hydrogenCount="0"/>
 ....
  </atomArray>
  <bondArray>
    <bond atomRefs2="a11 a12" id="a11_a12" order="S"/>
    <bond atomRefs2="a13 a11" id="a13_a11" order="S"/>
 ....
  </bondArray>
  <name>/Users/pm286/workspace/...xhtml2stm/molecules/image.g.2.13.svg</name>
</molecule>
```

This can be viewed interactively in Avogadro. To do this, run the following in your terminal:

```bash
$ avogadro target/image.g.2.13.xml/image.g.2.13.svg.molecule0.cml
```

You can them manipulate the molecule in 3D:

![Avogadro screenshot](https://raw.githubusercontent.com/ContentMine/ebi_workshop_20141006/master/sessions/4_AMI/chem_files/avogadro.2.13.png)


## Example: molecules from figures 2

## Example: reactions from figures

